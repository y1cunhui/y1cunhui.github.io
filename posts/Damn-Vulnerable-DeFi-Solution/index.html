<!DOCTYPE html><html lang="en" data-mode="light|dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Damn Vulnerable DeFi Solution" /><meta property="og:locale" content="en" /><meta name="description" content="中文/English" /><meta property="og:description" content="中文/English" /><link rel="canonical" href="https://y1cunhui.github.io/posts/Damn-Vulnerable-DeFi-Solution/" /><meta property="og:url" content="https://y1cunhui.github.io/posts/Damn-Vulnerable-DeFi-Solution/" /><meta property="og:site_name" content="y1cunhui" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-20T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Damn Vulnerable DeFi Solution" /><meta name="twitter:site" content="@y1cunhui2" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-20T00:00:00+08:00","datePublished":"2022-07-20T00:00:00+08:00","description":"中文/English","headline":"Damn Vulnerable DeFi Solution","mainEntityOfPage":{"@type":"WebPage","@id":"https://y1cunhui.github.io/posts/Damn-Vulnerable-DeFi-Solution/"},"url":"https://y1cunhui.github.io/posts/Damn-Vulnerable-DeFi-Solution/"}</script><title>Damn Vulnerable DeFi Solution | y1cunhui</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="y1cunhui"><meta name="application-name" content="y1cunhui"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">y1cunhui</a></div><div class="site-subtitle font-italic">Do not go gentle into that good night</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/y1cunhui" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/y1cunhui2" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['y1cunhui.yang','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Damn Vulnerable DeFi Solution</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Damn Vulnerable DeFi Solution</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658246400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 20, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/y1cunhui2">y1cunhui</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1309 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p><a href="">中文</a>/English</p><p>This post collects my solution to <a href="https://www.damnvulnerabledefi.xyz/index.html">Damn Vulnerable DeFi</a>, an excellent DeFi vulnerabilities practice platform. It’s really a good introduction for whom new to smart contract vulnerabilities. Compared to <a href="https://ethernaut.openzeppelin.com/">Ethernaut</a>, challenges here are more similar to real-world vulnerabilities, and the way we play it is more friendly. I also referred to some other blogs when finishing these challenges, thanks to these authors.</p><p>Before starting this series of challenges, I recommend you to learn UniswapV1 and UniswapV2. Not having any DeFi knowledge will make you struggle in basic concepts, and understanding these two protocols is almost enough for this practice. I strongly recommend two blogs where I learned these two protocols:</p><p><a href="https://jeiwan.net/posts/programming-defi-uniswap-1/">Programming DeFi: Uniswap.</a></p><p>and</p><p><a href="https://jeiwan.net/posts/programming-defi-uniswapv2-1/">Programming DeFi: Uniswap V2.</a></p><p>The author of these two wonderful blogs also wrote another well-known blog:</p><p><a href="https://jeiwan.net/posts/building-blockchain-in-go-part-1/">Building Blockchain in Go</a>.</p><p>Most details are omitted in this blog, and the full source code of my solution can be found <a href="https://github.com/y1cunhui/damn-vulnerable-defi/tree/myanswer">here</a>.</p><h2 id="1-unstoppable"><span class="mr-2">1. Unstoppable</span><a href="#1-unstoppable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The bug is in this line of <code class="language-plaintext highlighter-rouge">UnstoppableLender.sol</code>:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">assert</span><span class="p">(</span><span class="n">poolBalance</span> <span class="o">==</span> <span class="n">balanceBefore</span><span class="p">);</span>
</pre></table></code></div></div><p>Although as the comment says, it’s ensured by the <code class="language-plaintext highlighter-rouge">deposit</code> function; users can also send tokens to this contract directly without calling <code class="language-plaintext highlighter-rouge">deposit</code> and without triggering <code class="language-plaintext highlighter-rouge">fallback</code>(since it’s ERC20 token). So the solution is simple, just transfer tokens directly to the pool:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nx">hacker</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span>
<span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="nx">INITIAL_ATTACKER_TOKEN_BALANCE</span><span class="p">);</span>
</pre></table></code></div></div><h2 id="2-naive-receiver"><span class="mr-2">2. Naive receiver</span><a href="#2-naive-receiver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To drain the user’s contract, we just need to flash loan <code class="language-plaintext highlighter-rouge">0 ether</code> each time:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">flashLoan</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To wrap it in a single transaction, you can deploy an attacker contract and move the logic into the contract.</p><h2 id="3-truster"><span class="mr-2">3. Truster</span><a href="#3-truster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The main strange point is that, <code class="language-plaintext highlighter-rouge">target</code> and <code class="language-plaintext highlighter-rouge">borrowTo</code> can be different with <code class="language-plaintext highlighter-rouge">meg.sender</code>, which means that we can call arbitrary function on behalf of the pool. I choose to call the <code class="language-plaintext highlighter-rouge">approve</code> function of the token, and then I can call <code class="language-plaintext highlighter-rouge">transferFrom</code> to drain the pool.</p><h2 id="4-side-entrance"><span class="mr-2">4. Side entrance</span><a href="#4-side-entrance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s not hard to find that, we can flash loan some money and then deposit it. After this operation, the balance keeps not changed so the flash loan can succeed, and our deposit increased.</p><h2 id="5-the-rewarder"><span class="mr-2">5. The rewarder</span><a href="#5-the-rewarder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This challenge is a bit complex, and we need some time to make it clear by reading the challenge js.(Reading test files is always a good way to understand how this protocol works!)</p><p>The bug is in the <code class="language-plaintext highlighter-rouge">distributeRewards</code> function of contract <code class="language-plaintext highlighter-rouge">TheRewardPool</code>. When a new round came, it should always distribute the rewards first, and then do the snapshot; but this wrong implementation get confused here. So we just need to flash loan some money and deposit them.</p><h2 id="6--selfie"><span class="mr-2">6. Selfie</span><a href="#6--selfie" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s a bug in the governance system: one can flash loan a lot money to <code class="language-plaintext highlighter-rouge">hasEnoughVote</code> to execute arbitrary action.</p><p>Our attack can be splitted into 2 steps. First we flash loan enough money, queueAction, and return the money. After the delay, we can execute the action.</p><h2 id="7-compromised"><span class="mr-2">7. Compromised</span><a href="#7-compromised" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s a strange challenge somehow. We can get two private keys from the network flow, and use the private key to control the oracle to achieve our goal. But I’m wondering is there really private key information in the real-world network flow?</p><h2 id="8-puppet"><span class="mr-2">8. Puppet</span><a href="#8-puppet" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s a challenge based on Uniswap V1. If you’re not familiar with it, I strongly recommend you to read the blog I mentioned at the beginning of this article or see the offcial documentation. Reading it’s source code may be not a good idea since it’s written with Vyper.</p><p>The bug is that, the pool compute the price simply from the division of balance, which can be easily manipulated by hacker. So we just need to manipulate the shallow liquidity pool in Uniswap and borrow at an unreasonable price.</p><h2 id="9-puppet-v2"><span class="mr-2">9. Puppet V2</span><a href="#9-puppet-v2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Similar to above, it’s a challenge based on Uniswap V2, and if you’re not familiar with it please read the blog I recommended or the official doc.</p><p>The bug is also similar to challenge 8, where the only difference is that you need to interact with Uniswap V2 functions. These two challenges tells us that, we need to use the TWAP(Time-weighted Average Price) as our oracle instead of the simple division result. For more info about TWAP, you can read the <a href="https://docs.uniswap.org/protocol/V2/concepts/advanced-topics/pricing">official doc</a> or the <a href="https://uniswap.org/whitepaper.pdf">whitepaper</a>.</p><h2 id="10-free-rider"><span class="mr-2">10. Free Rider</span><a href="#10-free-rider" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The bug is in the <code class="language-plaintext highlighter-rouge">buyMany</code> and <code class="language-plaintext highlighter-rouge">buyOne</code> function of the marketplace contract. When some one want to but many NFTs, each <code class="language-plaintext highlighter-rouge">buyOne</code> just check the <code class="language-plaintext highlighter-rouge">msg.value</code>. Which means you just need to pay once to buy many NFTs.</p><p>We just need to flash loan some money first, then offer and buy for some times to drain the marketplace.</p><h2 id="11-backdoor"><span class="mr-2">11. backdoor</span><a href="#11-backdoor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is a really interesting challenge, and I find the way to solve it from other blogs. I’d like to describe it in my own way again.</p><p>First I’m not familiar with <code class="language-plaintext highlighter-rouge">Gnosis Safe</code>, so I cannot understand the code quickly. I just need to find what it wants me to do:</p><ol><li><p>Every user do not have <code class="language-plaintext highlighter-rouge">beneficiary</code> identity in the end, which function in the <code class="language-plaintext highlighter-rouge">walletRegistry</code> could change this? ——&gt;<code class="language-plaintext highlighter-rouge">proxyCreated</code></p><li><p>With the comments, I know this function will be called in <code class="language-plaintext highlighter-rouge">GnosisSafeProxyFactory::createProxyWithCallback</code> ——&gt; see this function.</p><li><p>With some basic knowledge of Uniswap, we know that <code class="language-plaintext highlighter-rouge">Factory</code> contract is something to create the real logic contract quickly. After reading the code, I know that it will call <code class="language-plaintext highlighter-rouge">initializer</code> of the real <code class="language-plaintext highlighter-rouge">Proxy</code> contract. Also, by the information of <code class="language-plaintext highlighter-rouge">walletRegistry</code>:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">require</span><span class="p">(</span><span class="kt">bytes4</span><span class="p">(</span><span class="n">initializer</span><span class="p">[</span><span class="o">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="n">GnosisSafe</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="nb">selector</span><span class="p">,</span> <span class="s">"Wrong initialization"</span><span class="p">);</span>
</pre></table></code></div></div><p>I know I will call the <code class="language-plaintext highlighter-rouge">setup</code> function of the <code class="language-plaintext highlighter-rouge">GnosisSafe</code> contract via <code class="language-plaintext highlighter-rouge">GnosisSafeProxy</code>’s <code class="language-plaintext highlighter-rouge">delegatecall</code></p><li><p>By reading the <code class="language-plaintext highlighter-rouge">setup</code> function, I find a strange parameter thanks to the comments:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c1">/// @param fallbackHandler Handler for fallback calls to this contract
</span></pre></table></code></div></div><p>This parameter is controlled by us! As a result, it’s just a tranditional “controlled delegatecall address” vulnerability. What we want it to get its money, so we can just delegatecall the token contract to transfer token to attacker.</p></ol><p>Full code can be seen in my github link at the beginning of this article. I really learned a lot in the way of finding this bug.</p><h2 id="12-climber"><span class="mr-2">12. climber</span><a href="#12-climber" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Bug of this code is here:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="kt">address</span><span class="p">[]</span> <span class="k">calldata</span> <span class="n">targets</span><span class="p">,</span>
        <span class="kt">uint256</span><span class="p">[]</span> <span class="k">calldata</span> <span class="n">values</span><span class="p">,</span>
        <span class="kt">bytes</span><span class="p">[]</span> <span class="k">calldata</span> <span class="n">dataElements</span><span class="p">,</span>
        <span class="kt">bytes32</span> <span class="n">salt</span>
    <span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Must provide at least one target"</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">values</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">targets</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">dataElements</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

        <span class="kt">bytes32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">getOperationId</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">dataElements</span><span class="p">,</span> <span class="n">salt</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">uint8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">targets</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">functionCallWithValue</span><span class="p">(</span><span class="n">dataElements</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        
        <span class="nb">require</span><span class="p">(</span><span class="n">getOperationState</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">OperationState</span><span class="p">.</span><span class="n">ReadyForExecution</span><span class="p">);</span>
        <span class="n">operations</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">executed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>We notice that it first execute all the actions, and then check if it’s ready for execution. Obviously it does not follow the <a href="https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html">Checks Effects Interactions</a> pattern in programming. Although it will not trigger re-entrancy vulnerability as most cases, we can execute something when it’s not ready, and make it to be ready in the process of execution.</p><p>Since we want to call the sweep function of <code class="language-plaintext highlighter-rouge">vault</code>, and the <code class="language-plaintext highlighter-rouge">timelock</code> contract is just the owner of <code class="language-plaintext highlighter-rouge">vault</code>, we can try to upgrade the <code class="language-plaintext highlighter-rouge">vault</code> implementation and drain the vault. It’s true, but I suffered a lot trouble in coding this idea. I always suffered some unexpected error, and it’s difficult to debug and code because of the upgradeable pattern…</p><p>You can see my final solution in the github repo. I choose to transfer the ownership to my attacker contract address, and use <code class="language-plaintext highlighter-rouge">upgradeToAndCall</code> to finish the attack.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Congratulations for finishing this series of challenges! You may feel that you learn a lot of DeFi knowledge and audition experience, as I did.</p><p>Welcome candid criticism to all kinds of error(knowledge or grammar) in my article by github issue, or contact me with email.</p><h2 id="reference"><span class="mr-2">Reference</span><a href="#reference" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://ventral.digital/posts/tag/Damn+Vulnerable+DeFi+v2">write-up series on Damn Vulnerable DeFi V2</a> <a href="https://cmichel.io/damn-vulnerable-de-fi-solutions/">Damn Vulnerable DeFi Solutions</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/security/'>Security</a>, <a href='/categories/defi/'>DeFi</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Damn+Vulnerable+DeFi+Solution+-+y1cunhui&url=https%3A%2F%2Fy1cunhui.github.io%2Fposts%2FDamn-Vulnerable-DeFi-Solution%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Damn+Vulnerable+DeFi+Solution+-+y1cunhui&u=https%3A%2F%2Fy1cunhui.github.io%2Fposts%2FDamn-Vulnerable-DeFi-Solution%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fy1cunhui.github.io%2Fposts%2FDamn-Vulnerable-DeFi-Solution%2F&text=Damn+Vulnerable+DeFi+Solution+-+y1cunhui" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/y1cunhui2">y1cunhui</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
